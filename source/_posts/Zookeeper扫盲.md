title: Zookeeper扫盲
author: YyWang
date: 2019-08-29 15:23:15
tags: 分布式
categories: 分布式
---
### Zookeeper

是一个分布式协调服务框架，这句话对于刚接触ZK（Zookeeper下文简称ZK）的我来说太抽象了，很难理解，只知道它能提供一些服务能够实现配置管理、命名服务、分布式锁等等，也就是在这些场景下会使用到ZK，这样说好像还是很难理解；之后，我找到了一个比较好理解的点，就是从CAP理论的角度，这需要对CAP有些了解，提前做了功课([CAP和BASE](http://yywang.top/2019/08/26/CAP%E5%92%8CBASE/#more))，简单来说在分布式系统中出现网络故障时，最多满足其中的两项，而P是必须要满足的，那么就需要从CP和AP中做选择了；ZK就是可保证CP的框架，最后我的理解就是ZK通过特定的数据结构，封装一系列算法通过API的方式提供分布式环境数据一致性的服务，所有需要数据一致性的场景都可以使用ZK，也就是上面提到的配置管理、命名服务、分布式锁等等场景

### 入门
#### 数据结构
ZK提供了一套类似于文件目录的数据结构，叫做多层级的节点命名空间，每个节点（ZK中称为znode）都可以存放数据且每个节点下都有若干个子节点，听起来和树的结构差不多，其实也一样，目录也是一种树结构的实现，znode可以理解为文件夹，文件夹中可以存放文件（znode可以存放数据），也可以存放文件夹（znode也可以存放znode）

##### znode的类型
* PERSISTENT--持久化目录节点
	* 客户端和ZK断开连接后节点依然存在
* PERSISTENT_SEQUENTIAL--持久化顺序编号目录节点
	* 与持久化目录节点相同，只是多了ZK对节点的顺序编号
* EPHEMERAL--临时目录节点
	* 客户端和ZK断开连接后节点被删除
* EPHEMERAL_SEQUENTIAL--临时顺序编号目录节点
	* 与临时目录节点相同，只是多了ZK对节点的顺序编号 

#### 通知机制
ZK还提供了类似于观察这模式的通知机制，称为watcher事件，可以观察到znode的变化，来通知客户端，之后客户端再做相应的业务逻辑

### 使用场景
#### 命名服务
这里命名服务指的是通过指定名字获取对应的资源，将资源存储在特定路径的znode中，根据路径就可以找到资源，类比目录结构来说，拿到文件的地址就能通过地址来找到文件，有点像是URL的意思，但是由于ZK数据结构设计的因素ZK不能存放较大的数据；微服务框架中的注册中心需要存放provider和consumer的信息，并且consumer要能够感知provider的实时状态，ZK可以根据provider和consumer的地址映射成临时znode结构，这样既保存了provider和consumer的信息还能感知彼此的状态
#### 配置管理
一句话解释----动态下发配置文件变化；通过ZK客户端watch配置文件，一旦配置文件发生变化马上通知客户端做对应的处理
#### 分布式锁
多个客户端再ZK的同一个目录下尝试创建临时znode，成功创建znode意味着获得锁成功，下个客户端发现目录下已经存在znode则对该znode添加watch机制，当znode消失即为释放锁后，通知客户端尝试创建znode来获取锁，这是公平锁；非公平锁的则创建临时有序的znode，相当于一个队列，后面的节点watch前一个节点的znode的状态，队头的znode为获得锁成功的几点

### 选举算法
#### ZK节点的状态
* LOOKING--当前节点不知道leader是谁，正在搜索
* LEADING--当前节点为集群的leader
* FOLLOWING--目前已有leader，当前节点负责与leader节点同步

#### 选举过程
在两种情况下会进行选举，1.服务器初始化启动 2.集群中leader节点故障

起初集群中的节点没有leader或者不知道leader是谁，此时节点的状态为LOOKING，如果当前集群存在leader（该节点新加入集群），此节点发送投票信息想要选举leader会被告知当前leader的信息，此节点只需和leader节点建立连接，并进行状态同步即可；

如果当前集群不存在leader节点，则需要投票进行选举

* 此时所有节点皆为LOOKING状态，并编辑投票信息发送给集群的其他节点，投票信息的格式为（SID,ZXID）（服务器的唯一标识，事务ID），SID是自己配置的，ZXID理解为当前节点数据的版本；
* 集群中的节点会受到其他节点的投票信息，加上自己的那一票会根据一个规则会投出第二轮的选票
  * 节点会在自己收到的选票中，选择ZXID最大的作为第二轮的选票发送给集群中其他节点
  * 如果ZXID相同则选择SID最大的作为第二轮的选票发送给集群中其他节点
* 集群中的节点在接收到第二轮选票后进行统计（包含自己的一票），获得集群中一半以上（>n/2）数量投票的节点当选leader进入LEADING状态，其余节点进入FOLLOWING状态

总结一下，集群中要获得一半以上的投票才能当选leader，所以集群最少为3台，并且数量是奇数；集群中ZXID越大的节点（当前节点数据版本越新）优先当选leader

### 安装与启动
整个过程没有难度也很好理解，跟着[这篇文章](https://www.jianshu.com/p/5491d16e6abd)做就完事了

### 最后
本文是对于Zookeeper的扫盲，大致了解ZK的基本原理，为了更好的理解工作中的项目，具有目的性，一些细节没有去研究，下回再补，😋

### 参考资料
[ZooKeeper典型应用场景一览](http://jm.taobao.org/2011/10/08/1232/)

[笔记：Mac上zookeeper的安装与启动](https://www.jianshu.com/p/5491d16e6abd)

[zookeeper面试题](https://segmentfault.com/a/1190000014479433?utm_source=tag-newest)
